#! /bin/bash
set -e

# sh /home/wletsou/scripts/haplotype_rpart.sh haplotype_estimates.ukbb_bca_cases+controls.chr11.68850000-69231641.txt rs2376558_C=1,rs149949063_G=0,rs144905179_A=0,rs74674490_G=0,rs11228502_C=0,rs12577213_A=0,rs73520512_T=0,rs10896431_T=0,rs7116054_T=0,rs74897859_T=0,rs67039008_A=1,rs55703863_C=0,rs17149775_G=0,rs117236867_G=0,rs11228530_C=0,rs17309046_C=0,rs56134379_A=0,rs74342245_A=0,rs35435383_A=0,rs10792029_G=1,rs78208050_G=0,rs61881109_A=0,rs75590802_A=0,rs11228565_A=0,rs7937094_T=0,rs7130881_G=0,rs111762835_A=0,rs4930672_A=0,rs116951063_T=0,rs118004919_A=0,rs35637432_A=0,rs34737133_T=0,rs78656034_T=0,rs74551015_A=0,rs117821797_T=0,rs12275849_C=0,rs56103266_C=0,rs117131950_A=0,rs12274095_A=0,rs10896461_G=1,rs7124547_T=1,rs72932105_T=0,rs115223540_T=0,rs117186144_T=0,rs12802601_C=0,rs61882193_G=0,rs12790064_G=1,rs11263641_C=0,rs76855139_T=0,rs74471298_A=0 rs79373485_T=0,rs4444099_T=0,rs117752342_T=0,rs76987532_T=0,rs1122316_A=0,rs2298764_C=0,rs117222887_A=0,rs76809977_T=0,rs559664_G=1,rs657315_T=0,rs498931_G=0,rs71465432_T=0,rs183782062_T=0,rs79442425_T=0,rs111929748_T=0,rs117490805_A=0 # h2
# reduced (minsplit = 10) = rs74674490_G=0,rs11228502_C=0,rs10896431_T=0,rs67039008_A=1,rs17149775_G=0,rs117236867_G=0,rs11228530_C=0,rs56134379_A=0,rs61881109_A=0,rs11228565_A=0,rs78656034_T=0,rs117821797_T=0,rs12275849_C=0,rs10896461_G=1,rs7124547_T=1,rs72932105_T=0,rs12790064_G=1,rs11263641_C=0,rs76855139_T=0,rs74471298_A=0

# sh /home/wletsou/scripts/haplotype_rpart.sh haplotype_estimates.ukbb_bca_cases+controls.chr11.68850000-69231641.txt rs2376558_C=1,rs61881030_A=0,rs149949063_G=0,rs144905179_A=0,rs74674490_G=0,rs12577213_A=0,rs73520512_T=0,rs3892895_G=1,rs7116054_T=0,rs17308715_T=0,rs67039008_A=1,rs117236867_G=0,rs11228530_C=0,rs17309046_C=0,rs56134379_A=0,rs72932540_G=0,rs78033785_T=0,rs74342245_A=0,rs35435383_A=0,rs117694794_T=0,rs10792029_G=1,rs10896445_C=1,rs78208050_G=0,rs61881109_A=0,rs75590802_A=0,rs7937094_T=0,rs7931342_G=1,rs10896449_G=1,rs7130881_G=0,rs111762835_A=0,rs4930672_A=0,rs116951063_T=0,rs118004919_A=0,rs35637432_A=0,rs34737133_T=0,rs11825015_T=0,rs78656034_T=0,rs74551015_A=0,rs117821797_T=0,rs12275849_C=0,rs117131950_A=0,rs7103126_C=0,rs116926312_T=0,rs11539762_A=0,rs142581206_T=0,rs11228610_C=0,rs12274095_A=0,rs73512137_T=0,rs11601693_A=0,rs12224376_A=0,rs78919175_T=0,rs7124547_T=0,rs11603814_G=0,rs72932105_T=0,rs117186144_T=0,rs79487139_T=0,rs11600497_A=0,rs72932198_A=0,rs12802601_C=0,rs76855139_T=0,rs74471298_A=0 rs79373485_T=0,rs4444099_T=0,rs117752342_T=0,rs76987532_T=0,rs1122316_A=0,rs2298764_C=0,rs117222887_A=0,rs76809977_T=0,rs559664_G=1,rs657315_T=0,rs498931_G=0,rs71465432_T=0,rs183782062_T=0,rs79442425_T=0,rs111929748_T=0,rs117490805_A=0 # h3
# reduced (minsplit = 10) = rs74674490_G=0,rs3892895_G=1,rs67039008_A=1,rs117236867_G=0,rs56134379_A=0,rs72932540_G=0,rs74342245_A=0,rs10896445_C=1,rs61881109_A=0,rs10896449_G=1,rs7130881_G=0,rs111762835_A=0,rs118004919_A=0,rs11825015_T=0,rs7124547_T=0,rs11603814_G=0,rs79487139_T=0,rs11600497_A=0,rs76855139_T=0

# sh /home/wletsou/scripts/haplotype_rpart.sh haplotype_estimates.ukbb_bca_cases+controls.chr11.68850000-69231641.txt rs2376558_C=1,rs61881030_A=0,rs149949063_G=0,rs144905179_A=0,rs74674490_G=0,rs12577213_A=0,rs7116054_T=0,rs17308715_T=0,rs117236867_G=0,rs11228530_C=0,rs17309046_C=0,rs78033785_T=0,rs74342245_A=0,rs35435383_A=0,rs117694794_T=0,rs10792029_G=1,rs78208050_G=0,rs61881109_A=0,rs7937094_T=0,rs7119988_A=0,rs111762835_A=0,rs4930672_A=0,rs11228599_T=0,rs7940107_A=0,rs72930267_T=0,rs7946255_C=0,rs116951063_T=0,rs118004919_A=0,rs35637432_A=0,rs34737133_T=0,rs11825015_T=0,rs78656034_T=0,rs74551015_A=0,rs117821797_T=0,rs12275849_C=0,rs56103266_C=0,rs117131950_A=0,rs116926312_T=0,rs11539762_A=0,rs142581206_T=0,rs11228610_C=0,rs12274095_A=0,rs12224376_A=0,rs7124547_T=1,rs11603814_G=1,rs115223540_T=0,rs117186144_T=0,rs11600497_A=0,rs72932198_A=0,rs12802601_C=0,rs61882193_G=0,rs12790064_G=1,rs11263638_A=0,rs11263641_C=0,rs76855139_T=0,rs74471298_A=0 rs79373485_T=0,rs4444099_T=0,rs117752342_T=0,rs76987532_T=0,rs1122316_A=0,rs2298764_C=0,rs117222887_A=0,rs76809977_T=0,rs559664_G=1,rs657315_T=0,rs498931_G=0,rs71465432_T=0,rs183782062_T=0,rs79442425_T=0,rs111929748_T=0,rs117490805_A=0 # h4
# reduced (minsplit = 10) = rs2376558_C=1,rs74674490_G=0,rs7116054_T=0,rs78033785_T=0,rs74342245_A=0,rs61881109_A=0,rs35637432_A=0,rs34737133_T=0,rs11825015_T=0,rs78656034_T=0,rs12275849_C=0,rs56103266_C=0,rs11539762_A=0,rs7124547_T=1,rs11603814_G=1,rs117186144_T=0,rs11600497_A=0,rs61882193_G=0,rs12790064_G=1,rs11263638_A=0,rs11263641_C=0,rs76855139_T=0,rs74471298_A=0

# sh /home/wletsou/scripts/haplotype_rpart.sh haplotype_estimates.ukbb_bca_cases+controls.chr11.68850000-69231641.txt rs2376558_C=1,rs149949063_G=0,rs144905179_A=0,rs74674490_G=0,rs72930627_A=0,rs72930631_C=0,rs11228502_C=0,rs12577213_A=0,rs73520512_T=0,rs10896431_T=0,rs74897859_T=0,rs55703863_C=0,rs17149775_G=0,rs117236867_G=0,rs11228530_C=0,rs17309046_C=0,rs56134379_A=0,rs72932540_G=0,rs78033785_T=0,rs74342245_A=0,rs35435383_A=0,rs117694794_T=0,rs10792029_G=1,rs78208050_G=0,rs61881109_A=0,rs75590802_A=0,rs7937094_T=0,rs7931342_G=0,rs10896449_G=0,rs7130881_G=0,rs111762835_A=0,rs4930672_A=0,rs116951063_T=0,rs118004919_A=0,rs35637432_A=0,rs34737133_T=0,rs11825015_T=0,rs78656034_T=0,rs117821797_T=0,rs56103266_C=0,rs117131950_A=0,rs7103126_C=1,rs116926312_T=0,rs142581206_T=0,rs12274095_A=0,rs10896461_G=1,rs78919175_T=0,rs7124547_T=1,rs12789955_G=0,rs115223540_T=0,rs28378931_G=0,rs117186144_T=0,rs72932198_A=0,rs12802601_C=0,rs12796465_G=0,rs61882193_G=0,rs12790064_G=1,rs11263638_A=0 rs79373485_T=0,rs4444099_T=0,rs117752342_T=0,rs76987532_T=0,rs1122316_A=0,rs2298764_C=0,rs117222887_A=0,rs76809977_T=0,rs559664_G=1,rs657315_T=0,rs498931_G=0,rs71465432_T=0,rs183782062_T=0,rs79442425_T=0,rs111929748_T=0,rs117490805_A=0 # h5
# reduced (minsplit = 10) = rs74674490_G=0,rs72930631_C=0,rs11228502_C=0,rs10896431_T=0,rs17149775_G=0,rs117236867_G=0,rs11228530_C=0,rs78033785_T=0,rs117694794_T=0,rs7931342_G=0,rs116951063_T=0,rs11825015_T=0,rs7103126_C=1,rs142581206_T=0,rs12274095_A=0,rs115223540_T=0,rs72932198_A=0,rs61882193_G=0

# sh /home/wletsou/scripts/haplotype_rpart.sh haplotype_estimates.ukbb_bca_cases+controls.chr11.68850000-69231641.txt rs2376558_C=1,rs149949063_G=0,rs144905179_A=0,rs74674490_G=0,rs11228502_C=0,rs12577213_A=0,rs73520512_T=0,rs3892895_G=1,rs10896431_T=0,rs74897859_T=0,rs17308715_T=0,rs55703863_C=0,rs17149775_G=0,rs117236867_G=0,rs11228530_C=0,rs17309046_C=0,rs56134379_A=0,rs72932540_G=0,rs78033785_T=0,rs74342245_A=0,rs35435383_A=0,rs4495899_G=0,rs10792029_G=1,rs10896445_C=0,rs78208050_G=0,rs61881109_A=0,rs75590802_A=0,rs11228565_A=0,rs7937094_T=0,rs7931342_G=0,rs10896449_G=0,rs7130881_G=0,rs7119988_A=0,rs111762835_A=0,rs4930672_A=0,rs11228599_T=0,rs7940107_A=0,rs72930267_T=0,rs7946255_C=0,rs116951063_T=0,rs118004919_A=0,rs35637432_A=0,rs34737133_T=0,rs11825015_T=0,rs74551015_A=0,rs117821797_T=0,rs12275849_C=0,rs56103266_C=0,rs117131950_A=0,rs7103126_C=0,rs116926312_T=0,rs11539762_A=0,rs142581206_T=0,rs11228610_C=0,rs12274095_A=0,rs73512137_T=0,rs11601693_A=0,rs10896461_G=0,rs12224376_A=0,rs78919175_T=0,rs7124547_T=0,rs12789955_G=0,rs7481709_C=0,rs115223540_T=0,rs28378931_G=0,rs7102705_G=1,rs117186144_T=0,rs79487139_T=0,rs11600497_A=0,rs72932198_A=0,rs12802601_C=0,rs12796465_G=0,rs12790064_G=1,rs11263638_A=0,rs11263641_C=1,rs76855139_T=0,rs74471298_A=0 rs79373485_T=0,rs4444099_T=0,rs117752342_T=0,rs76987532_T=0,rs1122316_A=0,rs2298764_C=0,rs117222887_A=0,rs76809977_T=0,rs559664_G=1,rs657315_T=0,rs498931_G=0,rs71465432_T=0,rs183782062_T=0,rs79442425_T=0,rs111929748_T=0,rs117490805_A=0 # h6
# reduced (minsplit = 1) = rs74674490_G=0,rs11228502_C=0,rs3892895_G=1,rs55703863_C=0,rs11228530_C=0,rs17309046_C=0,rs78033785_T=0,rs4495899_G=0,rs10896445_C=0,rs78208050_G=0,rs75590802_A=0,rs11228599_T=0,rs10896461_G=0,rs12789955_G=0,rs7481709_C=0,rs11600497_A=0,rs11263641_C=1

# sh /home/wletsou/scripts/haplotype_rpart.sh haplotype_estimates.ukbb_bca_cases+controls.chr11.68850000-69231641.txt rs2376558_C=1,rs896973_T=1,rs61881030_A=0,rs149949063_G=0,rs144905179_A=0,rs1123665_G=0,rs3829241_A=1,rs74674490_G=0,rs12577213_A=0,rs73520512_T=0,rs3892895_G=1,rs7116054_T=0,rs74897859_T=0,rs17308715_T=0,rs55703863_C=1,rs117236867_G=0,rs11228530_C=0,rs17309046_C=0,rs56134379_A=0,rs72932540_G=0,rs12418948_T=0,rs78033785_T=0,rs74342245_A=0,rs35435383_A=0,rs10792029_G=1,rs78208050_G=0,rs61881109_A=0,rs75590802_A=0,rs11228565_A=0,rs7937094_T=0,rs7130881_G=0,rs7119988_A=0,rs111762835_A=0,rs4930672_A=0,rs11228599_T=0,rs7940107_A=0,rs72930267_T=0,rs7946255_C=0,rs116951063_T=0,rs118004919_A=0,rs35637432_A=0,rs34737133_T=0,rs11825015_T=0,rs78656034_T=0,rs74551015_A=0,rs117821797_T=0,rs12275849_C=0,rs56103266_C=0,rs117131950_A=0,rs7103126_C=0,rs116926312_T=0,rs11539762_A=0,rs142581206_T=0,rs11228610_C=0,rs12274095_A=0,rs73512137_T=0,rs11601693_A=0,rs12224376_A=0,rs78919175_T=0,rs7124547_T=0,rs11603814_G=0,rs72932105_T=0,rs12789955_G=0,rs7481709_C=0,rs115223540_T=0,rs28378931_G=0,rs7102705_G=1,rs117186144_T=0,rs79487139_T=0,rs11600497_A=0,rs72932198_A=0,rs12802601_C=0,rs12796465_G=0,rs12790064_G=1,rs11263638_A=0,rs76855139_T=0,rs74471298_A=0 rs79373485_T=0,rs4444099_T=0,rs117752342_T=0,rs76987532_T=0,rs1122316_A=0,rs2298764_C=0,rs117222887_A=0,rs76809977_T=0,rs559664_G=1,rs657315_T=0,rs498931_G=0,rs71465432_T=0,rs183782062_T=0,rs79442425_T=0,rs111929748_T=0,rs117490805_A=0 # h7
# reduced (minsplit = 1) = rs3829241_A=1,rs7116054_T=0,rs55703863_C=1,rs11228530_C=0,rs56134379_A=0,rs11228599_T=0,rs78656034_T=0,rs7124547_T=0,rs7481709_C=0,rs11600497_A=0,rs76855139_T=0

# sh /home/wletsou/scripts/haplotype_rpart.sh haplotype_estimates.ukbb_bca_cases+controls.chr11.68850000-69231641.txt rs2376558_C=1,rs61881030_A=0,rs149949063_G=0,rs144905179_A=0,rs74674490_G=0,rs12577213_A=0,rs73520512_T=0,rs3892895_G=1,rs7116054_T=0,rs17308715_T=0,rs67039008_A=1,rs17149775_G=1,rs117236867_G=0,rs11228530_C=0,rs17309046_C=0,rs56134379_A=0,rs72932540_G=0,rs12418948_T=0,rs78033785_T=0,rs74342245_A=0,rs35435383_A=0,rs117694794_T=0,rs10792029_G=1,rs78208050_G=0,rs61881109_A=0,rs7937094_T=0,rs7119988_A=0,rs111762835_A=0,rs4930672_A=0,rs11228599_T=0,rs7940107_A=0,rs72930267_T=0,rs7946255_C=0,rs116951063_T=0,rs118004919_A=0,rs35637432_A=0,rs34737133_T=0,rs11825015_T=0,rs78656034_T=0,rs74551015_A=0,rs117821797_T=0,rs12275849_C=0,rs56103266_C=0,rs117131950_A=0,rs7103126_C=0,rs116926312_T=0,rs11539762_A=0,rs142581206_T=0,rs11228610_C=0,rs12274095_A=0,rs73512137_T=0,rs11601693_A=0,rs10896461_G=0,rs12224376_A=0,rs78919175_T=0,rs7124547_T=1,rs11603814_G=1,rs72932105_T=0,rs7481709_C=1,rs115223540_T=0,rs11600497_A=0,rs72932198_A=0,rs12802601_C=0,rs61882193_G=0,rs12790064_G=1,rs11263638_A=0,rs11263641_C=0,rs76855139_T=0,rs74471298_A=0 rs79373485_T=0,rs4444099_T=0,rs117752342_T=0,rs76987532_T=0,rs1122316_A=0,rs2298764_C=0,rs117222887_A=0,rs76809977_T=0,rs559664_G=1,rs657315_T=0,rs498931_G=0,rs71465432_T=0,rs183782062_T=0,rs79442425_T=0,rs111929748_T=0,rs117490805_A=0 # h8
# reduced (minsplit = 1) = rs74674490_G=0,rs17149775_G=1,rs74342245_A=0,rs61881109_A=0,rs116951063_T=0,rs35637432_A=0,rs7103126_C=0,rs10896461_G=0,rs78919175_T=0,rs7124547_T=1,rs11603814_G=1,rs72932105_T=0,rs7481709_C=1,rs61882193_G=0,rs11263638_A=0

# sh /home/wletsou/scripts/haplotype_rpart.sh haplotype_estimates.ukbb_bca_cases+controls.chr11.68850000-69231641.txt rs2376558_C=1,rs896973_T=0,rs61881030_A=0,rs149949063_G=0,rs144905179_A=0,rs1123665_G=1,rs3829241_A=0,rs11228502_C=0,rs12577213_A=0,rs73520512_T=0,rs10896431_T=0,rs74897859_T=0,rs17308715_T=0,rs55703863_C=0,rs117236867_G=0,rs11228530_C=0,rs56134379_A=0,rs78033785_T=0,rs74342245_A=0,rs35435383_A=0,rs4495899_G=1,rs117694794_T=0,rs10792029_G=1,rs10896445_C=1,rs78208050_G=0,rs61881109_A=0,rs75590802_A=0,rs7937094_T=0,rs7119988_A=0,rs111762835_A=0,rs4930672_A=0,rs11228599_T=0,rs7940107_A=0,rs72930267_T=0,rs7946255_C=0,rs116951063_T=0,rs118004919_A=0,rs34737133_T=0,rs11825015_T=0,rs78656034_T=0,rs74551015_A=0,rs117821797_T=0,rs56103266_C=0,rs117131950_A=0,rs116926312_T=0,rs11539762_A=0,rs142581206_T=0,rs11228610_C=0,rs12274095_A=0,rs12224376_A=0,rs7124547_T=1,rs11603814_G=1,rs115223540_T=0,rs28378931_G=0,rs117186144_T=0,rs79487139_T=0,rs11600497_A=0,rs72932198_A=0,rs12802601_C=0,rs12796465_G=0,rs4275647_T=0,rs61882193_G=0,rs12790064_G=1,rs11263638_A=0,rs11263641_C=0,rs76855139_T=0,rs74471298_A=0 rs79373485_T=0,rs4444099_T=0,rs117752342_T=0,rs76987532_T=0,rs1122316_A=0,rs2298764_C=0,rs117222887_A=0,rs76809977_T=0,rs559664_G=1,rs657315_T=0,rs498931_G=0,rs71465432_T=0,rs183782062_T=0,rs79442425_T=0,rs111929748_T=0,rs117490805_A=0 # h9
# reduced (minsplit = 1) = rs1123665_G=1,rs10896431_T=0,rs55703863_C=0,rs4495899_G=1,rs10896445_C=1,rs111762835_A=0,rs11228599_T=0,rs11825015_T=0,rs7124547_T=1,rs11603814_G=1,rs28378931_G=0,rs79487139_T=0,rs4275647_T=0,rs12790064_G=1,rs11263641_C=0,rs76855139_T=0,rs74471298_A=0

# sh /home/wletsou/scripts/haplotype_rpart.sh haplotype_estimates.ukbb_bca_cases+controls.chr11.68850000-69231641.txt rs2376558_C=1,rs896973_T=0,rs61881030_A=0,rs149949063_G=0,rs144905179_A=0,rs1123665_G=1,rs3829241_A=0,rs11228502_C=0,rs12577213_A=0,rs73520512_T=0,rs10896431_T=0,rs74897859_T=0,rs17308715_T=0,rs55703863_C=0,rs117236867_G=0,rs11228530_C=0,rs56134379_A=0,rs78033785_T=0,rs74342245_A=0,rs35435383_A=0,rs4495899_G=1,rs117694794_T=0,rs10792029_G=1,rs10896445_C=1,rs78208050_G=0,rs61881109_A=0,rs75590802_A=0,rs7937094_T=0,rs7119988_A=0,rs111762835_A=0,rs4930672_A=0,rs11228599_T=0,rs7940107_A=0,rs72930267_T=0,rs7946255_C=0,rs116951063_T=0,rs118004919_A=0,rs34737133_T=0,rs11825015_T=0,rs78656034_T=0,rs74551015_A=0,rs117821797_T=0,rs56103266_C=0,rs117131950_A=0,rs116926312_T=0,rs11539762_A=0,rs142581206_T=0,rs11228610_C=0,rs12274095_A=0,rs12224376_A=0,rs7124547_T=1,rs11603814_G=1,rs115223540_T=0,rs28378931_G=0,rs117186144_T=0,rs79487139_T=0,rs11600497_A=0,rs72932198_A=0,rs12802601_C=0,rs12796465_G=0,rs4275647_T=0,rs61882193_G=0,rs12790064_G=1,rs11263638_A=0,rs11263641_C=0,rs76855139_T=0,rs74471298_A=0 rs79373485_T=0,rs4444099_T=0,rs117752342_T=0,rs76987532_T=0,rs1122316_A=0,rs2298764_C=0,rs117222887_A=0,rs76809977_T=0,rs559664_G=1,rs657315_T=0,rs498931_G=0,rs71465432_T=0,rs183782062_T=0,rs79442425_T=0,rs111929748_T=0,rs117490805_A=0 # h11
# reduced = rs1123665_G=1,rs10896431_T=0,rs55703863_C=0,rs4495899_G=1,rs10896445_C=1,rs111762835_A=0,rs11228599_T=0,rs11825015_T=0,rs7124547_T=1,rs11603814_G=1,rs28378931_G=0,rs79487139_T=0,rs4275647_T=0,rs12790064_G=1,rs11263641_C=0,rs76855139_T=0,rs74471298_A=0

# sh /home/wletsou/scripts/haplotype_rpart.sh haplotype_estimates.ukbb_bca_cases.chr11.129361171-129561171.txt rs80124429_T=0,rs2933904_A=0,rs1994848_G=1,rs117977204_T=0,rs11221744_A=0,rs113400047_C=0,rs2933896_A=0,rs28489138_A=0,rs73028742_G=0,rs10219165_G=0,rs73028755_T=0,rs76683043_A=0,rs55771446_A=0,rs10894063_A=0,rs78120825_G=0,rs78120825_T=0,rs34437830_A=0,rs903019_G=1,rs1493268_A=1,rs79412578_G=0,rs76468967_T=0,rs117937738_A=0,rs76842030_A=0,rs11221776_T=1,rs79576939_T=0,rs79226713_C=0,rs118018867_A=0 "rs79373485_T=0,rs4444099_T=0,rs117752342_T=0,rs76987532_T=0,rs1122316_A=0,rs2298764_C=0,rs117222887_A=0,rs76809977_T=0,rs559664_G=1,rs657315_T=0,rs498931_G=0,rs71465432_T=0,rs183782062_T=0,rs79442425_T=0,rs111929748_T=0,rs117490805_A=0" "" # rs11820646 h3
# reduced =


POPULATION=$1 # haplotype estiamtes file
TEST_HAPLOTYPE=$2 # comma-separated list of alleles corresponding to columns of POPULATION to be used for scoring haplotype and for partitioning
INCLUDED_HAPLOTYPE=$3 # comma-separated list of alleles corresponding to columns of POPULATION to be included in haplotype definition but not for partitioning
MINSPLIT=$4 # rpart minsplit parameter, minimum number of items in split-off bin

if [ -z $HOME_DIR ];
then
  HOME_DIR=$(echo "/home/wletsou/scripts")
fi

if [ -z $DIRECTORY ];
then
  DIRECTORY=$PWD
fi
cd $DIRECTORY

module load R/3.6.1

if [ -z $MINSPLIT ]
then
  MINSPLIT=10
fi

POPULATION=($(echo $POPULATION | perl -pne 's/([^,]+)[,]*/$1 /g'))

TEST_HAPLOTYPE=($(echo $TEST_HAPLOTYPE | perl -pne 's/[:]/ /g'))

for ((i=0;i<${#POPULATION[@]};i++))
do
  for ((j=0;j<${#TEST_HAPLOTYPE[@]};j++))
  do
    echo Haplotype $j \(${TEST_HAPLOTYPE[j]}\):
    printf "\n"
    # get counts of TEST_HAPLOTYPE only if INCLUDED_HAPLOTYPE is included in line; print counts and all snp alleles
    echo awk \'BEGIN{OFS=\"\\t\"\; n=split\(\"${TEST_HAPLOTYPE[j]}\",array,\",\"\)\; for \(i=1\;i\<=n\;i++\) {a=gensub\(\"\(.*\)=\(.*\)\",\"\\\\1\",\"g\",array[i]\)\; b=gensub\(\"\(.*\)=\(.*\)\",\"\\\\2\",\"g\",array[i]\)\; test_snps[a]=b}\; delete array\; m=split\(\"${INCLUDED_HAPLOTYPE}\",array,\",\"\)\; for \(i=1\;i\<=m\;i++\) {a=gensub\(\"\(.*\)=\(.*\)\",\"\\\\1\",\"g\",array[i]\)\; b=gensub\(\"\(.*\)=\(.*\)\",\"\\\\2\",\"g\",array[i]\)\; included_snps[a]=b} } NR==1{ delete test_col\; delete included_col\; for \(i=2\;i\<=NF\;i++\) {if \(\$i in test_snps\) {test_col[i]=\$i}\; if \(\$i in included_snps\) {included_col[i]=\$i} }\; if \(length\(test_col\)!=n \|\| length\(included_col\)!=m\) {print \"Wrong number of alleles found.\"\; exit 1}\; printf \"id\\ttest_haplotype\\tincluded_haplotype\\t\" } NR\>1{ included_count=1\; test_count=0\; for \(j in included_col\) {if \(\$j!=included_snps[included_col[j]]\) {included_count=0}\; if \(\$j !~ /[0-9]/\) {included_count=\"NA\"} }\; if \(included_count==1\) {test_count=1\; for \(j in test_col\) {if \(\$j!=test_snps[test_col[j]]\) {test_count=0}\; if \(\$j !~ /[0-9]/\) {test_count=\"NA\"} } } printf \"%s\\t%s\\t%s\\t\",\$1,test_count,included_count } NR\>=1{for \(j=2\;j\<=NF\;j++\) {printf \"%s%s\",\$j,\(j\<NF?\"\\t\":\"\\n\"\)} }\' ${POPULATION[i]} \> haplotype_counts.${POPULATION[i]%.*}.txt
    printf "\n"
    awk 'BEGIN{OFS="\t"; n=split("'${TEST_HAPLOTYPE[j]}'",array,","); for (i=1;i<=n;i++) {a=gensub("(.*)=(.*)","\\1","g",array[i]); b=gensub("(.*)=(.*)","\\2","g",array[i]); test_snps[a]=b}; delete array; m=split("'${INCLUDED_HAPLOTYPE}'",array,","); for (i=1;i<=m;i++) {a=gensub("(.*)=(.*)","\\1","g",array[i]); b=gensub("(.*)=(.*)","\\2","g",array[i]); included_snps[a]=b} } NR==1{ delete test_col; delete included_col; for (i=2;i<=NF;i++) {if ($i in test_snps) {test_col[i]=$i}; if ($i in included_snps) {included_col[i]=$i} }; if (length(test_col)!=n || length(included_col)!=m) {print "Wrong number of alleles found."; exit 1}; printf "id\ttest_haplotype\tincluded_haplotype\t" } NR>1{ included_count=1; test_count=0; for (j in included_col) {if ($j!=included_snps[included_col[j]]) {included_count=0}; if ($j !~ /[0-9]/) {included_count="NA"} }; if (included_count==1) {test_count=1; for (j in test_col) {if ($j!=test_snps[test_col[j]]) {test_count=0}; if ($j !~ /[0-9]/) {test_count="NA"} } }; printf "%s\t%s\t%s\t",$1,test_count,included_count } NR>=1{for (j=2;j<=NF;j++) {printf "%s%s",$j,(j<NF?"\t":"\n")} }' ${POPULATION[i]} > haplotype_counts.${POPULATION[i]%.*}.txt
    printf "\n"

    echo Rscript ${HOME_DIR}/haplotype_rpart.R file=haplotype_counts.${POPULATION[i]%.*}.txt haplotype=\"included_haplotype,${TEST_HAPLOTYPE[j]}\" min_split=$MINSPLIT
    Rscript ${HOME_DIR}/haplotype_rpart.R file=haplotype_counts.${POPULATION[i]%.*}.txt haplotype="included_haplotype,${TEST_HAPLOTYPE[j]}" min_split=$MINSPLIT
    printf "\n"

    test -f haplotype_counts.${POPULATION[i]%.*}.txt && echo rm haplotype_counts.${POPULATION[i]%.*}.txt && printf "\n"
    test -f haplotype_counts.${POPULATION[i]%.*}.txt && rm haplotype_counts.${POPULATION[i]%.*}.txt
  done
done
